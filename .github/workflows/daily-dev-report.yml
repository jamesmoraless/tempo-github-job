name: Daily Dev Activity Report

on:
  schedule:
    # Runs daily at 22:00 UTC (â‰ˆ 5pm ET)
    - cron: "0 22 * * *"
  workflow_dispatch: {}  # Allows manual triggering from GitHub UI

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for Claude action OIDC authentication
    
    # Required secrets:
    # - ANTHROPIC_API_KEY: Your Anthropic API key for Claude
    # - SLACK_WEBHOOK_URL: Your Slack webhook URL for posting messages
    # - GITHUB_TOKEN: Automatically provided by GitHub Actions (no need to set manually)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for commit queries
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Collect GitHub activity
        id: collect
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/collect_activity_single_repo.py > activity.json
          echo "activity_json<<EOF" >> $GITHUB_OUTPUT
          cat activity.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Generate report with Claude
        id: claude
        continue-on-error: true          # ðŸ‘ˆ donâ€™t fail whole job if Claude errors (e.g. no credit)
        env:
          MODE: agent                     # ðŸ‘ˆ force the action out of tag mode
        uses: anthropics/claude-code-action@beta
        with:
          mode: agent                     # ðŸ‘ˆ also tell it via inputs
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: ""              # ðŸ‘ˆ disable tag-based triggers
          label_trigger: ""               # ðŸ‘ˆ disable label-based triggers
          direct_prompt: |
            You are generating a *daily dev activity report* for this GitHub repo.
            The JSON includes pull requests and commits from the past 24 hours with stats such as additions, deletions, changed_files, short_sha, html_url, and author identifiers (login, name, email).

            Produce Slack-formatted Markdown with these rules:
            1. If there is no activity, output exactly: "No activity in the last 24 hours."
            2. Otherwise, group sections by developer. Prefer `author_login` / `user_login`; fall back to name or email, use "Unknown" if nothing is available.
            3. For each developer, show totals of lines added and deleted from their commits (sum additions/deletions).
            4. List commits as bullet points. Format each bullet as `<html_url|short_sha> â€“ message (+additions/âˆ’deletions)`. If stats are missing, omit the additions/deletions portion.
            5. List PRs they touched as bullet points. Include number, title, state (open/merged), additions/deletions/changed_files, and a short note if merged. Add the PR URL using `<html_url|PR #number>`.
            6. For each PR, assign a *PR Quality Score* from 1 (needs work) to 5 (excellent). Base your score on size (additions/deletions), merge status, recency, number of commits, and any inferred polish. Give a one-line rationale per PR.
            7. Keep the overall message concise (under ~400 words) but ensure key data is included.

            Activity data:
            ${{ steps.collect.outputs.activity_json }}

      # NEW: dump all outputs so we can see what this action actually returns
      - name: Debug Claude outputs
        run: |
          echo "Raw Claude outputs:"
          echo '${{ toJson(steps.claude.outputs) }}'


      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Post to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          EXEC_FILE="${{ steps.claude.outputs.execution_file }}"

          if [ -z "$EXEC_FILE" ] || [ ! -f "$EXEC_FILE" ]; then
            MSG="Daily Dev Report: Claude ran but no execution file was found."
          else
            # The file is an array of objects; we want the first one that has "result"
            MSG=$(jq -r '[.[] | select(has("result"))][0].result // empty' "$EXEC_FILE")
            if [ -z "$MSG" ]; then
              # fallback: maybe it used "content" instead of "result"
              MSG=$(jq -r '[.[] | select(has("message"))][0].message.content[0].text // empty' "$EXEC_FILE")
            fi
            if [ -z "$MSG" ]; then
              MSG="Daily Dev Report: Claude ran but output was not in an expected shape. Check the workflow log."
            fi
          fi

          # escape + send to Slack
          PAYLOAD=$(printf '%s' "$MSG" | jq -Rs '{text: .}')
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
